<!DOCTYPE html>
<html lang="en">
 
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StudyGPT</title>
  <link rel="manifest" href="pwa.webmanifest">
  <script type="importmap">
        {
          "imports": {
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
          }
        }
      </script>
  <script type="module">

  </script>
</head>
<style>
  #output {
    text-wrap: pretty;
    font-size: 35pt;
    top: 10vh;
    height: 80vh;
    width: 100vw;
    background: black;
    color: white;
    border-radius: 5px;
    position: absolute;
    overflow-y: scroll;
  }

  .you {
    border-radius: 5px;
    position: absolute;
    left: 50%;
    width: 50%;
    text-wrap: pretty;
    font-size: 20pt;
    color: white;
    background: blue;
  }

  .gpt {
    border-radius: 5px;
    position: static;
    width: 50%;
    text-wrap: pretty;
    font-size: 20pt;
    color: white;
    background: darkslategray;
  }

  #input {
    height: 10vh;
    width: 100vw;
    position: absolute;
    top: 90vh;
  }
  #tabs{
    height: 10vh;
    width: 100vw;
    overflow-x: scroll;
    position: absolute;
    background: black;
  }
button{
  position: static;
  background: black;
  border: 1px solid white;
  font-size: 20pt;
  color: white;

}
</style>

<body>
  <div id="tabs"></div>
  <div id="output"></div>
  <h1 hidden id="load">Loading...</h1>
  <textarea id="input" placeholder="Press control or command enter to chat..."></textarea>
  <script type="module">
    var history = [];
    var message = 0;
    var lsname = "";
    var messages = [];
    var outputs = [];
    for (let i = 0; i < localStorage.length; i++) {
      const value = JSON.parse(localStorage.getItem("c" + i));
      outputs.push(value.out);
     var out = document.createElement("button");
    out.id = i;
    out.innerHTML = value.in;
     out.onclick = (e)=> {
      lsname = value.lsname;
      message = value.messages;
      document.querySelector("#output").innerHTML = value.out;
      socket.emit("chat", value.history);
     }
       document.querySelector("#tabs").appendChild(out);  
    }
    import { io } from "https://cdn.socket.io/4.7.5/socket.io.esm.min.js";
    const socket = io();
    document.querySelector("#input").onkeydown = (e) => {
      if (e.key == "Enter" && (e.ctrlKey || e.metaKey)) {
        message++;
if(message === 1){
origin =   document.querySelector("#input").value;
}
        document.querySelector("#output").innerHTML += "<div class='you'>" + document.querySelector("#input").value + "</div>" + "<br>"
        socket.emit("submit", document.querySelector("#input").value);
        document.querySelector("#load").hidden = false;
        document.querySelector("#output").scrollTop =  document.querySelector("#output").scrollHeight;
      }
    }
    socket.on("return", t => {
     var start = document.querySelector("#input").value;
      document.querySelector("#input").value = "";
      document.querySelector("#load").hidden = true;
      document.querySelector("#output").innerHTML += "<div class='gpt' style='top: 100%'>" + t + "</div>" + "<br>"
      if(message === 1){
        lsname = "c" + localStorage.length;
        history.push({role: "user", parts: start});
        history.push({role: "model", parts: t});
      localStorage.setItem("c" + localStorage.length, JSON.stringify({out: document.querySelector("#output").innerHTML, in: start, messages: message, lsname: lsname, history: history}));
      }
      else{
        localStorage.setItem(lsname, JSON.stringify({out: document.querySelector("#output").innerHTML, in: start, messages: message, lsname: lsname}));
      }   
    })
    document.addEventListener('DOMContentLoaded', init, false);
function init() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
      .then((reg) => {
        console.log('Service worker registered -->', reg);
      }, (err) => {
        console.error('Service worker not registered -->', err);
      });
  }
}
  </script>

</html>
